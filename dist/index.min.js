!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.dexieRelationships=t()}(this,function(){"use strict";function e(t){return null!=t&&("string"==typeof t||"number"==typeof t||t instanceof Date||Array.isArray(t)&&t.every(e))}var t=function(e){this.schema=e};t.prototype.getForeignKeys=function(){var e=this,t={};return Object.keys(this.schema).forEach(function(n){var r=e.schema[n].split(",");t[n]=r.filter(function(e){return e.indexOf("->")!==-1}).map(function(e){var t=e.split("->").map(function(e){return e.trim()}),n=t[0],r=t[1];return{index:n,targetTable:r.split(".")[0],targetIndex:r.split(".")[1]}})}),t},t.prototype.getCleanedSchema=function(){var e=this,t={};return Object.keys(this.schema).forEach(function(n){var r=e.schema[n].split(",");t[n]=r.map(function(e){return e.split("->")[0].trim()}).join(",")}),t};var n=function(n){var r=n.constructor,o=r.Promise;n.Table.prototype.with=function(e){return this.toCollection().with(e)},n.Collection.prototype.with=function(t){var r=this,i=this._ctx.table.name,a=n._allTables,f={};Object.keys(t).forEach(function(e){var n=t[e],o=r._ctx.table.schema.idxByName[n];if(o&&o.hasOwnProperty("foreignKey")){var c=o;f[c.foreignKey.targetTable]={column:e,index:c.foreignKey.targetIndex,targetIndex:c.foreignKey.index,oneToOne:!0}}else{var s=n;if(!a.hasOwnProperty(s))throw new Error("Relationship table "+s+" doesn't exist.");if(!a[s].schema.hasOwnProperty("foreignKeys"))throw new Error("Relationship table "+s+" doesn't have foreign keys set.");var u=a[s].schema.foreignKeys.filter(function(e){return e.targetTable===i});u.length>0&&(f[s]={column:e,index:u[0].index,targetIndex:u[0].targetIndex})}});var c=Object.keys(f);return this.toArray().then(function(t){var n=c.map(function(n){var r=f[n],o=t.map(function(e){return e[r.targetIndex]}).filter(e);return a[n].where(r.index).anyOf(o)}),r=n.map(function(e){return e.toArray()});return o.all(r).then(function(e){c.forEach(function(n,r){var o=f[n],a=e[r],c=o.targetIndex,s=o.index,u=o.column,h={};t.forEach(function(e){h[e[c]]=e}),a.forEach(function(e){var t=e[s],r=h[t];if(!r)throw new Error("Could not lookup foreign key where "+n+"."+s+" == "+i+"."+u+". The content of the failing key was: "+JSON.stringify(t)+".");o.oneToOne||!r.hasOwnProperty(u)?Object.defineProperty(r,u,{value:o.oneToOne?e:[e],enumerable:!1,configurable:!0,writable:!0}):o.oneToOne||r[u].push(e)})})}).then(function(){return t})})},n.Version.prototype._parseStoresSpec=r.override(n.Version.prototype._parseStoresSpec,function(e){return function(n,r){var o=new t(n),i=o.getForeignKeys(),a=e.call(this,o.getCleanedSchema(),r);return Object.keys(r).forEach(function(e){i.hasOwnProperty(e)&&(r[e].foreignKeys=i[e],i[e].forEach(function(t){r[e].idxByName[t.index].foreignKey=t}))}),a}})};return n});
